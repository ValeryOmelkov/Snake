class Game {
    constructor() {
        this._isNet = false;
        this._sizeX = 20;
        this._sizeY = 20;
        this._sizeCell = 30;
        this._speed = 50;
        this._countGame = 1;
        this._maxLength = 0;
        this._life = 500;
        this._isStarted = false;
        this._steps = 0;
        this._stepsNeeded = 300000; // Шагов перед обучением
        this._trainData = []; // Обучающая выборка
        this._canvas = document.getElementById('canvas');
        this._canvas.width = this._sizeX * this._sizeCell;
        this._canvas.height = this._sizeY * this._sizeCell;
        this._canvas.style.width = this._sizeX * this._sizeCell + 'px';
        this._canvas.style.height = this._sizeY * this._sizeCell + 'px';
        this._ctx = this._canvas.getContext('2d');
        this._startBtn = document.getElementById('start');
        this._startBtn.addEventListener('click', this._startGame.bind(this));
        this._pauseBtn = document.getElementById('pause');
        this._pauseBtn.addEventListener('click', this._pause.bind(this));
        this._restartBtn = document.getElementById('restart');
        this._restartBtn.addEventListener('click', this._restart.bind(this));
        this._MaxLengthA = document.getElementById('MaxLengthA');
        this._LengthA = document.getElementById('LengthA');
        this._CountGameA = document.getElementById('CountGameA');
        this._LifeA = document.getElementById('LifeA');
        this._MaxLengthNN = document.getElementById('MaxLengthNN');
        this._LengthNN = document.getElementById('LengthNN');
        this._CountGameNN = document.getElementById('CountGameNN');
        this._LifeNN = document.getElementById('LifeNN');
        const config = {
            inputSize: 24,
            hiddenLayers: [12],
            outputSize: 4,
            activation: 'relu',
            learningRate: 0.1,
        };
        this._net = new brain.NeuralNetwork(config);
        this._jsonDiv = document.getElementById('json');
        // Сеть в формате json, не смог найти варианта получше
        // Размер выборки | Размер поля | Название | Максимальный результат
        // 200 000        | 20х20       | NN200k20 |
        // 500 000        | 20х20       | NN500k20 | Max: 69
        // 100 000        | 10x10       | NN100k10 | Max: 42
        // 300 000        | 10x10       | NN300k10 | Max: 50
        const NN200k20 = '{"layers":[{"0":{},"1":{},"2":{},"3":{},"4":{},"5":{},"6":{},"7":{},"8":{},"9":{},"10":{},"11":{},"12":{},"13":{},"14":{},"15":{},"16":{},"17":{},"18":{},"19":{},"20":{},"21":{},"22":{},"23":{}},{"0":{"bias":-3.652800460982222,"weights":{"0":-2.2345802076682046,"1":4.222237969845532,"2":0.05368827442650437,"3":-4.9150335494336765,"4":-1.109005836019049,"5":0.6921246455827331,"6":1.9437984796308412,"7":-0.04065484548239749,"8":4.230380284451139,"9":0.3155258783783038,"10":0.04747222559355301,"11":2.712584655583628,"12":-5.654124637149933,"13":1.2456045081722147,"14":1.8372159412610791,"15":-2.074974140999593,"16":-6.696808176170625,"17":0.46512173934903606,"18":0.09295730726068341,"19":0.034420398191113616,"20":9.962697400194433,"21":-0.8178469347035325,"22":-2.3638535655573447,"23":-0.32497603326586366}},"1":{"bias":1.490460473533029,"weights":{"0":4.401179591268277,"1":-0.37293312415909124,"2":2.3069257875832103,"3":0.47166770406300224,"4":-1.9320686995643102,"5":-5.322845589716331,"6":-5.52214240254321,"7":-3.46241162907849,"8":1.909332661310615,"9":2.0270673992959205,"10":-0.2489726677711928,"11":-0.6110095395748106,"12":-1.2701525507737916,"13":-7.297924878996986,"14":-2.436256789411525,"15":-2.2965047831938974,"16":-1.889206078027831,"17":0.1185989802773208,"18":-0.08461033596699902,"19":0.5414023401407722,"20":-8.412258587669346,"21":1.1348801836768287,"22":8.579813814309931,"23":0.186098548241173}},"2":{"bias":0.6601498873447941,"weights":{"0":-0.9475123613741403,"1":-4.584408919239011,"2":0.8681749642382595,"3":3.9089626397118056,"4":-0.019783810642622083,"5":1.1260851076300893,"6":-0.3367641973927355,"7":-2.3369604833437934,"8":-1.1104358351816916,"9":-2.9406353552030358,"10":2.067761986582321,"11":1.800221358016214,"12":5.650944424282188,"13":-4.792227054647714,"14":-1.2988242444838385,"15":1.5011725321898834,"16":8.522934412650807,"17":-0.4592507330483385,"18":0.004722320036570693,"19":-0.3522839731441479,"20":-6.9049905521036745,"21":1.086808626869347,"22":3.6481181199531063,"23":0.7681654990425292}},"3":{"bias":-0.82281988841531,"weights":{"0":3.0024343049438897,"1":1.9943129849943029,"2":-0.8639834485324348,"3":-2.185291193366508,"4":-2.2751174955412585,"5":-1.129503301646453,"6":2.0794183952542658,"7":-0.187742674063207,"8":-6.9860497589056365,"9":2.9882197001769866,"10":-1.1820463846421778,"11":1.5658800995679822,"12":1.6028638606848933,"13":-1.2060873619110775,"14":0.297350159631811,"15":-7.451506059400288,"16":-5.770963547366319,"17":0.2883244219288916,"18":-0.19383086008435335,"19":1.0415542511172113,"20":-1.2791167030979869,"21":0.4420566432481233,"22":5.561378756692209,"23":-0.799555397649138}},"4":{"bias":0.3665516079832435,"weights":{"0":-0.024836125027846687,"1":5.27047268665646,"2":-0.8216958986383285,"3":-3.9263374940185067,"4":2.0998283859913176,"5":1.5817680312974984,"6":-3.98338793425443,"7":-1.1831822676286272,"8":-4.266491328460439,"9":5.4514163309076835,"10":-3.9827348900426287,"11":-1.2161466976092088,"12":1.4658438457578415,"13":-2.5459363555492835,"14":-2.1788045212504397,"15":0.8324834076773082,"16":8.297149524100902,"17":-0.1092050022614997,"18":0.0560690976019555,"19":-1.2663078453346213,"20":11.890169098294963,"21":-1.8168586988529556,"22":-7.3153303031386345,"23":1.0201714561337338}},"5":{"bias":1.7224834541458327,"weights":{"0":-5.375236063953147,"1":-3.866809789773635,"2":0.6659183570784658,"3":2.1504109543311616,"4":-0.9982082337349524,"5":0.7070218674963047,"6":4.869716718735225,"7":-1.008371486385394,"8":2.728241329069747,"9":0.1201982118742617,"10":-3.8095019546084874,"11":0.20993589507019478,"12":0.9836090416402481,"13":-0.44378280948348336,"14":-0.6749351115943559,"15":2.155120403890287,"16":-10.199673328071118,"17":0.4143197990103356,"18":-0.17072450809598197,"19":1.553228361370495,"20":2.1377322416347395,"21":0.7592768831367155,"22":-2.028352832885877,"23":-1.4666248678742118}},"6":{"bias":-0.27698908321125487,"weights":{"0":-6.689318438278664,"1":-1.4486324487399047,"2":-3.5076740219672424,"3":2.751131948059952,"4":4.030205354735208,"5":4.350925181412584,"6":-0.30452227442489255,"7":-1.6960673142737015,"8":-9.392405782652812,"9":-2.6112602672512915,"10":0.4102955080172494,"11":1.7655927860100593,"12":1.8227631359549783,"13":1.335852323885416,"14":2.4761353565295052,"15":0.4101025349361818,"16":7.161641533525576,"17":0.020472031569323344,"18":-0.06698716936420795,"19":-0.35025087168590674,"20":-1.542586956112258,"21":-0.40214796711242473,"22":-12.013868475586246,"23":0.7843157530759988}},"7":{"bias":0.6261912378172579,"weights":{"0":0.5442740299297875,"1":1.0875790987319967,"2":-5.816186294698568,"3":-4.574638926837301,"4":3.595630194923815,"5":2.349388978930022,"6":4.223429783919492,"7":-1.9108129429687355,"8":-0.18159204219751773,"9":0.9251847641943027,"10":-5.961770883105827,"11":0.143650816344382,"12":4.354523517326879,"13":-0.1152481445182526,"14":0.19303035179934447,"15":-0.1888282376845781,"16":-7.6959827892648605,"17":0.5267296333555993,"18":0.007181236185640039,"19":2.7262833614524244,"20":-13.642635411250549,"21":-0.0879034502461662,"22":1.2721934899680762,"23":-1.6074844267120703}},"8":{"bias":1.3139583025437926,"weights":{"0":-4.872408220889188,"1":-6.540239141603295,"2":3.9351186396959754,"3":3.0718971676152638,"4":-2.71287573334742,"5":-0.9448772717434053,"6":-0.21991049112218725,"7":-4.310380582198893,"8":5.846587890211826,"9":-3.453759117357882,"10":-0.0845894684896535,"11":-2.192549859890018,"12":-0.313024130398382,"13":0.05197219763800822,"14":-0.8311601879539743,"15":2.8897930788078177,"16":-1.670578693503534,"17":-0.20440131378412355,"18":-0.09227239756711754,"19":-1.3977920779840591,"20":6.753592753661421,"21":0.47597906387977174,"22":6.5145913644520315,"23":0.1382910658039254}},"9":{"bias":0.7126883961689765,"weights":{"0":-0.5320065561758597,"1":0.17382230128286788,"2":-1.0947643190042649,"3":0.2733863660516154,"4":2.6930245199100287,"5":1.180228776723782,"6":-0.9198553345063407,"7":-1.6276557093860067,"8":0.8786517527560184,"9":0.06873246275218661,"10":-2.32886944725142,"11":-4.711714385614424,"12":3.6282501161443075,"13":-1.227045425508726,"14":2.690750630227489,"15":3.3029443893467034,"16":2.763297030704343,"17":0.03893704479231011,"18":0.11931949658330376,"19":0.09895983203930636,"20":-7.3653963120051325,"21":-0.29387454455470224,"22":-1.0710220324365451,"23":0.09157990546841334}},"10":{"bias":-2.0796602248577534,"weights":{"0":1.0083092411329266,"1":-5.179769183808764,"2":2.831203854655276,"3":1.666330863674564,"4":-3.1703314729097296,"5":2.6521824394149656,"6":-1.9947293372259662,"7":2.6905094129947815,"8":1.3805321345702628,"9":-0.5370433177323808,"10":2.0571882981561678,"11":-3.0385054196085224,"12":-0.3066556059545324,"13":2.140370519154946,"14":1.7029600083861642,"15":-0.7432387760806294,"16":15.4519338553405,"17":-0.6975733974716016,"18":-0.011788429560202568,"19":-2.8765088350664922,"20":10.635179893342478,"21":0.31543390954648814,"22":8.579917404359655,"23":3.1087335247802805}},"11":{"bias":2.455991798306597,"weights":{"0":-0.017899056495147576,"1":0.7086325449656866,"2":-1.7059306500317715,"3":-5.712139314307623,"4":-1.509990230511818,"5":-2.9245424057881944,"6":0.6357911261054631,"7":-2.1633156642428704,"8":0.31165755728301753,"9":-1.6345359619942925,"10":-0.6696338665275959,"11":-11.233660766229107,"12":-0.09359898624728202,"13":5.289579058153964,"14":6.1909434476262115,"15":-1.2748435777821916,"16":-6.424295252899943,"17":-0.030060336243503804,"18":0.16627282231250462,"19":0.3864348028404435,"20":5.503251286673148,"21":0.09174077066751808,"22":-2.7671060871710575,"23":-0.7288003081887792}}},{"0":{"bias":0.6064005669041079,"weights":{"0":-5.3805404650693704,"1":-7.514051411659304,"2":6.325292959564812,"3":-8.69994707167693,"4":7.174084148307056,"5":-8.788909277616193,"6":6.534009746444098,"7":-3.6254097699051693,"8":-9.58500877476437,"9":5.6697920886382365,"10":4.490470853551706,"11":-8.165965214666093}},"1":{"bias":-2.6927676686110393,"weights":{"0":0.9936546142099598,"1":2.0181031848982767,"2":-8.242810367898754,"3":-1.6905616014155884,"4":-7.653111257829675,"5":4.419411864820204,"6":4.125443284958236,"7":10.726270382917741,"8":-7.02429481518613,"9":-0.8700712818918219,"10":-19.038310692986414,"11":11.579872971360956}},"2":{"bias":0.7621637289405366,"weights":{"0":7.469814794549486,"1":-9.995396600071958,"2":-7.228020921702935,"3":-1.9696307701523978,"4":6.825674154624358,"5":4.022378760994449,"6":-2.6142651973247504,"7":-12.318881062603134,"8":7.5063509794441385,"9":-10.071410644076924,"10":3.8735611636773144,"11":5.408355962370061}},"3":{"bias":-1.753284297535977,"weights":{"0":-11.531303342738664,"1":8.484465053598448,"2":5.556691913445922,"3":7.594153923987961,"4":-11.82110316611867,"5":-3.5917799353664677,"6":-13.24447027154668,"7":2.641057307418077,"8":2.7974267524450918,"9":1.3131128903431983,"10":1.7298044092652645,"11":-4.634427290289462}}}],"outputLookup":false,"inputLookup":false}';
        const NN500k20 = '{"layers":[{"0":{},"1":{},"2":{},"3":{},"4":{},"5":{},"6":{},"7":{},"8":{},"9":{},"10":{},"11":{},"12":{},"13":{},"14":{},"15":{},"16":{},"17":{},"18":{},"19":{},"20":{},"21":{},"22":{},"23":{}},{"0":{"bias":1.9776040904462204,"weights":{"0":8.85977078368409,"1":-0.8918024063860498,"2":-21.38092885963533,"3":15.931057630562288,"4":-14.389242158108162,"5":-1.7383286030043679,"6":11.430192743234116,"7":-9.126298901904208,"8":18.658135349271454,"9":2.8178245284828685,"10":-13.332530693844298,"11":7.360862668051252,"12":-17.711261549107682,"13":-0.5508470917043374,"14":18.827720148409572,"15":-18.37511692744278,"16":-12.276150954362437,"17":0.9840311785792966,"18":6.632145411711446,"19":39.74724130207542,"20":15.489091224447302,"21":-16.379947293763752,"22":-13.7347036428367,"23":-28.656711578876347}},"1":{"bias":-3.3536097372743274,"weights":{"0":11.523987858422842,"1":-12.84619025096009,"2":51.038650537261965,"3":-22.57259396733693,"4":18.212122712941348,"5":3.0570618236413156,"6":-4.327814158844531,"7":1.9338917803810007,"8":0.5379977991975438,"9":10.148518963465396,"10":6.162000321743587,"11":-3.9206771583264084,"12":1.5696263071314631,"13":-0.7653474982522889,"14":-3.220146522267162,"15":1.904013109222599,"16":79.42993083136771,"17":-15.658679373947946,"18":-18.441775691637627,"19":-13.517281325828,"20":1.0768317286828133,"21":27.557264798188662,"22":23.800287162309427,"23":26.300663552189913}},"2":{"bias":-10.700867575145569,"weights":{"0":68.22801321150048,"1":-68.39022896028355,"2":119.74814420977435,"3":-43.456391328872705,"4":45.820067781425344,"5":4.4044837830156975,"6":-4.129979645772812,"7":0.9784467047688714,"8":0.6338056480645835,"9":0.07222105888789586,"10":3.392035697181915,"11":-2.06034422899458,"12":22.29679236058902,"13":0.9898829806332513,"14":-10.62638609176245,"15":1.9549327884170828,"16":12.874612711454109,"17":-2.7075281442722394,"18":-40.55140140145019,"19":-30.525095979298417,"20":-15.890199467667857,"21":11.211345348099671,"22":7.747045453514566,"23":14.388818475389128}},"3":{"bias":-8.49994617806389,"weights":{"0":6.522317078599797,"1":-1.8648777877608778,"2":4.7843800052736425,"3":-0.35576467918145765,"4":0.12207231193116658,"5":-1.9892677981096862,"6":0.7682980003933082,"7":-4.425892838810359,"8":1.970521527958906,"9":-1.4250925256367135,"10":2.1483332811638363,"11":-4.341234392966568,"12":-108.76825286722793,"13":2.9730790900380417,"14":4.619669338202775,"15":-0.16731876464599824,"16":-23.26667979138074,"17":-5.2153943085801755,"18":-15.981109884938661,"19":-14.128499255458063,"20":178.6245813721861,"21":4.29199558170488,"22":10.253774003417318,"23":0.21896602044302832}},"4":{"bias":-3.096585093946288,"weights":{"0":-3.6278833796783796,"1":1.895889547948548,"2":8.567428305854655,"3":-7.807661048445685,"4":-20.176118760181843,"5":19.496329716448,"6":-22.51430807423635,"7":3.0976562847292026,"8":0.9564224515606341,"9":-1.7706739250556782,"10":2.1348372255196826,"11":-0.5417863346715798,"12":-0.9299048412240503,"13":2.3316544822090752,"14":-79.57971620953882,"15":-3.0463055507310557,"16":-25.954536192927907,"17":-17.639516759637182,"18":-23.6118488142938,"19":-15.368281672869628,"20":-12.42341545053511,"21":44.26436255467027,"22":121.77687028448804,"23":-3.807302068014311}},"5":{"bias":5.06565866820938,"weights":{"0":-9.487204710933643,"1":-58.1785533013107,"2":21.280129881537317,"3":-20.05247868685911,"4":-21.404868160330622,"5":-25.797987222046192,"6":26.98233719806867,"7":-58.64467401965304,"8":5.537138883001913,"9":-26.05888702749909,"10":-4.956947497612076,"11":-2.4043660979080723,"12":8.851120554256442,"13":-3.042696130564904,"14":-4.127983894326328,"15":-1.8995848364188352,"16":-17.11825148458802,"17":8.86787287540308,"18":6.129372308300617,"19":5.429831226813967,"20":-2.1659659868440406,"21":10.480521122049012,"22":8.021411630500447,"23":-7.421788260958929}},"6":{"bias":-9.133788193546685,"weights":{"0":12.338313564624297,"1":-13.913740181709787,"2":21.13001378626524,"3":-7.704169172584957,"4":-21.45770012728141,"5":27.012430206473955,"6":-26.63109431558905,"7":-1.1072485676472164,"8":9.162895683100272,"9":-0.8436456074062019,"10":-5.038372890865553,"11":9.244368218138224,"12":-9.247915682345598,"13":1.5143896092913482,"14":-0.3981658444999221,"15":0.817673553910628,"16":-13.880399781012075,"17":-3.6382856642179795,"18":-10.18964613404717,"19":-7.565366441198268,"20":4.581887603258168,"21":10.406677339667757,"22":1.8253153120611014,"23":-0.24525264161966837}},"7":{"bias":-2.4365591874940846,"weights":{"0":-44.64100987327206,"1":12.118021827968906,"2":-6.039113496786992,"3":-2.551715915674661,"4":5.2660476007537085,"5":-4.41494519221261,"6":-23.270824463637563,"7":27.77539160310962,"8":-45.10938247110982,"9":-3.616500685396359,"10":2.4074170590819652,"11":-3.3762471579774225,"12":3.9422321951522017,"13":0.1924698705860748,"14":0.2411510972445574,"15":2.3169812479777403,"16":90.57285839283774,"17":-16.802382459629694,"18":-10.930275257266164,"19":-9.927227724838673,"20":-26.678335835573627,"21":-4.063497401901504,"22":25.88002840359272,"23":43.63043199349099}},"8":{"bias":37.395861711438364,"weights":{"0":4.402118256641799,"1":-10.188406795194988,"2":-37.53074952658048,"3":-10.564398109710387,"4":5.813134895404111,"5":14.99359991054016,"6":-21.269009983861974,"7":3.0442744861813016,"8":8.258876865395383,"9":2.7285183681867444,"10":-50.88746560631912,"11":-1.2656004229628595,"12":10.619551855508675,"13":-0.0641466022932873,"14":1.3282736377171733,"15":-1.6031188144570165,"16":2.761013412619531,"17":2.15313084464263,"18":1.4102079486825687,"19":3.5384292455641724,"20":-5.121606042490682,"21":-8.924127233271099,"22":-17.590978431144777,"23":9.298258073163781}},"9":{"bias":2.4825877616889422,"weights":{"0":-7.236349473469202,"1":7.30481576019486,"2":-7.698095743828181,"3":-1.2022258382931443,"4":8.113706221965575,"5":-2.77084244569226,"6":2.0284419696410882,"7":0.6635582770857829,"8":-9.856908956974298,"9":7.61414134988627,"10":-8.202926400281683,"11":-0.15618042735637538,"12":6.693339331383453,"13":-3.876013236026836,"14":5.396687836169583,"15":-1.6986712301057427,"16":1.7968888161036178,"17":16.52094849091321,"18":5.105548010202295,"19":0.23032666805646107,"20":-20.188058078890336,"21":-13.871559882081575,"22":-16.0295072650081,"23":0.8167731918261644}},"10":{"bias":12.45986142871684,"weights":{"0":7.1255732233028874,"1":-5.482622619257126,"2":-25.289697854608427,"3":28.957471820768447,"4":-30.295331541535226,"5":4.020432780681364,"6":-0.2868311324865579,"7":-3.351868017797153,"8":-11.963072665344786,"9":-3.763113277917976,"10":-10.56631401354775,"11":15.600720149665559,"12":-3.0132724019817343,"13":14.973502296598852,"14":-11.808671631428394,"15":0.4712119712322684,"16":-7.788702118002425,"17":8.492948239341754,"18":-7.71217143371277,"19":0.9607863961060586,"20":58.78639099978824,"21":2.9100023425800043,"22":-8.736615237696299,"23":-5.395468593258515}},"11":{"bias":2.3145036793287255,"weights":{"0":9.87825324916936,"1":2.067034457769573,"2":-8.034089231149393,"3":1.267502208985344,"4":-9.155980731755076,"5":2.718937868573723,"6":3.9443177566038585,"7":-4.144153045558365,"8":-1.7004606130819775,"9":-0.8326766018118175,"10":-0.023629080402379356,"11":3.2237542974737647,"12":-5.780854119672711,"13":19.37740549423634,"14":0.6887637861237352,"15":6.746840858472135,"16":-39.76799694030762,"17":8.777458521083588,"18":26.211502427285165,"19":15.717662453898887,"20":41.08911340850129,"21":15.938093481850265,"22":35.97644686640262,"23":-18.684794954581168}}},{"0":{"bias":-4.1655105290201595,"weights":{"0":-3.1776440033697204,"1":3.2492479053061043,"2":-0.9874205720746206,"3":-11.618590061552428,"4":-14.375117615847856,"5":-8.359204887117338,"6":-45.079746001672575,"7":6.473074062950309,"8":-2.9274414693791124,"9":4.489712497619033,"10":2.699281840311197,"11":-2.348180741120209}},"1":{"bias":-23.283320812751153,"weights":{"0":2.908076664410413,"1":-3.5297668478306976,"2":-0.266480658119025,"3":-7.569860652909989,"4":-7.82211042305777,"5":3.236219129993761,"6":-2.0901855415635624,"7":-6.068289798859966,"8":22.455827228412865,"9":2.9018019546817575,"10":-1.8539630805533207,"11":1.93691106568431}},"2":{"bias":-5.118009301499581,"weights":{"0":4.168530971480973,"1":3.2122022190350963,"2":-3.0247532954685696,"3":8.606078848394501,"4":-8.986277069648333,"5":0.35814414496952857,"6":3.2040909822302455,"7":-0.7990668459921889,"8":-4.174645651581836,"9":-2.5697851298895764,"10":1.5848299486344153,"11":1.4750026135509817}},"3":{"bias":-2.556093422357109,"weights":{"0":-2.656594786412156,"1":2.5930939139026035,"2":3.424181398726573,"3":-6.060735402277428,"4":11.981738260727358,"5":2.3946788455439254,"6":-2.0397347321239234,"7":-5.280891086301625,"8":1.387865258364517,"9":-5.384684775746029,"10":-1.824762120641605,"11":-0.06803715013341807}}}],"outputLookup":false,"inputLookup":false}';
        const NN100k10 = '{"layers":[{"0":{},"1":{},"2":{},"3":{},"4":{},"5":{},"6":{},"7":{},"8":{},"9":{},"10":{},"11":{},"12":{},"13":{},"14":{},"15":{},"16":{},"17":{},"18":{},"19":{},"20":{},"21":{},"22":{},"23":{}},{"0":{"bias":28.149628278084435,"weights":{"0":3.621097243160855,"1":0.12531056004623878,"2":6.637375359083815,"3":-5.144740168260754,"4":9.666901745261045,"5":2.246425596510338,"6":9.04904249778701,"7":-1.4531723100985208,"8":3.827413029662483,"9":4.325182826300165,"10":-2.0924157808913852,"11":1.7534450740495358,"12":7.290168205940538,"13":0.3030086369254939,"14":-35.2473697038986,"15":-5.394737174554296,"16":-1.3973363264135206,"17":-2.121768449739359,"18":-7.893797174507827,"19":12.551509014105442,"20":-12.112542678081542,"21":-9.53677205829679,"22":-20.483539108786744,"23":-1.6083949372158082}},"1":{"bias":-16.68841862584798,"weights":{"0":18.317040364483287,"1":-9.417603933328797,"2":13.617385919836734,"3":-4.574736932364537,"4":8.645423713678062,"5":-9.190244449968148,"6":16.301942113802138,"7":-8.905500583864098,"8":-2.0455260347116533,"9":-7.279285819130323,"10":-8.402599644132778,"11":6.014307508768839,"12":12.161902895350297,"13":5.5057336297791,"14":-3.5517022918488363,"15":-2.43869970165918,"16":-38.78621317935438,"17":3.7777098210990925,"18":12.956111773221346,"19":4.839966658927247,"20":23.64102538321301,"21":10.015700767689657,"22":-2.640249572952582,"23":-18.461194617864244}},"2":{"bias":7.663650765928001,"weights":{"0":-2.410084837204122,"1":-7.28698842789562,"2":-2.612361048275664,"3":8.145845443679738,"4":-35.03261003267287,"5":18.2759499143423,"6":-19.978893087792198,"7":0.2833353047994636,"8":-3.280616888222563,"9":-3.580725967430334,"10":4.994438995127742,"11":-1.5687498443831953,"12":-3.4198271095967674,"13":1.7227187117822018,"14":-5.410301500011862,"15":1.8422111711591427,"16":-18.324506731848015,"17":-20.77879248722191,"18":-24.02031451972262,"19":6.348605457313799,"20":11.538240302565168,"21":11.49181922925821,"22":20.029760071715927,"23":-21.184298214876023}},"3":{"bias":22.364620370585378,"weights":{"0":6.350867377398135,"1":-5.738555619389615,"2":4.945517839999565,"3":2.384320229161545,"4":0.50539895635779,"5":-0.5706929537171038,"6":-0.5459040708009318,"7":0.2495436174180043,"8":-0.4740254654199518,"9":0.8981532898022043,"10":-27.76270055479171,"11":-17.678089664058398,"12":19.68864493201257,"13":2.1001097047120467,"14":-0.6581763449742875,"15":3.0064391025848005,"16":1.2000933929253594,"17":-2.991201586524135,"18":2.4600810490112255,"19":0.353860971398618,"20":2.6217563895162215,"21":1.017348713009721,"22":25.80573052856493,"23":-2.589044228494689}},"4":{"bias":2.212785689999129,"weights":{"0":4.626224386450143,"1":-2.2813683546429164,"2":-8.612533782540769,"3":1.4460297408076626,"4":-3.7201632715867854,"5":2.492033846402043,"6":-0.6215657216164737,"7":-0.6172829196483812,"8":5.652929452241607,"9":-0.1823484144772705,"10":-10.246460605615523,"11":4.802795119324185,"12":-7.638028686679686,"13":-0.6471461396564796,"14":6.480442223912966,"15":-5.367597077884063,"16":-67.44360223534939,"17":-1.2377101828023196,"18":13.614777172760927,"19":2.4172008009674553,"20":-10.775535319579975,"21":-21.188929295103144,"22":-25.636673810988178,"23":-33.685960177834126}},"5":{"bias":40.27402896863204,"weights":{"0":-28.795071212222226,"1":-8.2217146299301,"2":-0.33270672621876035,"3":4.632478024982506,"4":-13.727868773543664,"5":4.2378580577028195,"6":1.4368202772056784,"7":-7.279712380821213,"8":-45.634746993503384,"9":3.596756821354139,"10":-4.172196982935114,"11":2.034871115678167,"12":4.562704201491816,"13":-1.2641139868042015,"14":7.483089226770665,"15":-1.0223982177228848,"16":4.202168513956788,"17":8.09373506237059,"18":12.017946965556526,"19":9.585979808652867,"20":-2.0728905574416316,"21":-4.3837663620146206,"22":-37.47383761357703,"23":7.149430959576058}},"6":{"bias":-6.213618255682076,"weights":{"0":-1.8796170570584636,"1":1.8636497163521228,"2":2.573980613010399,"3":-2.3327280499187655,"4":0.2910030950215279,"5":-4.781165612489,"6":6.107054716276131,"7":0.6283596960097259,"8":0.4960054179898724,"9":-1.1781166096442768,"10":1.5217323968176637,"11":0.7432755111895109,"12":-58.51406511699457,"13":4.95687087237693,"14":-0.20065394333338563,"15":-0.17797516917636264,"16":-8.546820222346684,"17":-3.2906580542794157,"18":-0.28394811034652206,"19":12.376402085460887,"20":73.61077944034264,"21":0.5822932767769676,"22":-3.469679151037058,"23":-1.8342267208557967}},"7":{"bias":5.820945700172761,"weights":{"0":2.5711252097833217,"1":-0.9387919872622736,"2":-25.08344339712928,"3":-13.733111938584578,"4":11.418487226751681,"5":0.9456961346937401,"6":-11.519313293266304,"7":-1.00080380679272,"8":0.31152451096171363,"9":-2.4800776095853507,"10":0.3145080950505901,"11":-0.36925882148607164,"12":-4.002560872287941,"13":-5.0530559109641136,"14":-10.70670844102334,"15":0.1742277120147467,"16":4.855492356849915,"17":5.351891019880446,"18":-0.6418262807056015,"19":2.326113040580491,"20":5.025026204203901,"21":-8.176676490862308,"22":-8.782090983451308,"23":-1.4164482137509211}},"8":{"bias":-6.71682586944025,"weights":{"0":-1.0272236061365556,"1":-0.006121686652376672,"2":11.109360926847515,"3":-1.8361840827869393,"4":1.8866809283233565,"5":2.0641196909245143,"6":12.586802968829574,"7":2.7617338104668563,"8":-4.7432045351982355,"9":4.6329404409065305,"10":-3.1329775535047695,"11":2.969571694437926,"12":1.217809452044784,"13":7.810337687932769,"14":1.857196966174213,"15":-1.6069471935953235,"16":7.818476400896036,"17":-2.4289935442632826,"18":25.154774724782406,"19":6.719736185067258,"20":6.783253174073406,"21":-10.633425465430483,"22":-35.48415793653508,"23":1.98721707151055}},"9":{"bias":-4.665811307273065,"weights":{"0":4.236942576072839,"1":-5.416188057594127,"2":9.793860706108637,"3":2.3088378640554934,"4":-6.452097807603862,"5":2.811055293342524,"6":-0.10003073969123155,"7":0.08153082009423021,"8":8.707439240076276,"9":-2.11879553882355,"10":8.325806842919944,"11":0.619468182509968,"12":-4.933984585604872,"13":0.8176085899943641,"14":-2.76999499271629,"15":-2.744592277559386,"16":-16.460273926677292,"17":-10.462564913406947,"18":-10.085632259262319,"19":-10.149461593158641,"20":10.949360419029345,"21":7.215975542622884,"22":42.81263677568487,"23":-3.2038337779372767}},"10":{"bias":-0.7401593818596971,"weights":{"0":9.572562470405595,"1":-10.334787723099069,"2":16.6409497035106,"3":0.28157626477599285,"4":-10.148106610632475,"5":17.752515603824097,"6":-19.023121795888617,"7":-0.11741660258407129,"8":1.4149877821715746,"9":-0.43944683889754077,"10":-13.02483939553967,"11":3.91401016693642,"12":-0.015832617571453468,"13":0.2321790817679315,"14":-0.9135631165665261,"15":0.29739812326155185,"16":14.902661036857317,"17":-23.176227610249015,"18":-21.401586017992752,"19":-10.350401271845481,"20":16.224791161800972,"21":6.638763326299383,"22":6.351567651612785,"23":3.332363085329776}},"11":{"bias":-9.98422189968011,"weights":{"0":-0.03963706679710378,"1":0.620709900566766,"2":14.905128457731449,"3":-12.07587524420546,"4":21.470672029984875,"5":-5.940960779096114,"6":7.3407020773485625,"7":2.436170884897634,"8":-6.3457378572227,"9":0.31676615912350947,"10":7.544456122701003,"11":-1.1784719557799561,"12":7.119516439256867,"13":0.35434121244042965,"14":-2.938227307395953,"15":0.08031977749521843,"16":18.153086509199735,"17":-6.283677267587546,"18":-4.302121080767076,"19":-7.993217069713382,"20":-11.230329826919013,"21":2.371759364053834,"22":15.658988326438005,"23":12.6054217250898}}},{"0":{"bias":-5.533278643927079,"weights":{"0":-1.5642297927743838,"1":-3.0371666163761675,"2":-4.801605777756758,"3":-2.454214796555735,"4":-3.970821392421544,"5":5.368940025245793,"6":-3.6667243711300794,"7":4.729769679127798,"8":2.287898427321745,"9":-1.6181634773751614,"10":2.0004413810688044,"11":4.121722126517496}},"1":{"bias":-2.666167036298871,"weights":{"0":1.4418803234405022,"1":2.9356567024641484,"2":0.7979067932927318,"3":6.5178423956590175,"4":3.6454460486105558,"5":-2.334505420117607,"6":-4.614855071349755,"7":1.2271454613216326,"8":-0.2701179971004195,"9":-6.639490967001727,"10":-3.1472553847263107,"11":-4.8538368282748765}},"2":{"bias":-2.2387433212671617,"weights":{"0":-5.638009926562839,"1":-3.0360849330189454,"2":0.5140375960888024,"3":-6.795562433330084,"4":-0.20915139791782347,"5":-0.7338856420282426,"6":7.279938238529583,"7":4.5854314855643405,"8":3.6767485601450676,"9":7.587164558405882,"10":4.327145429047294,"11":-4.762296229412767}},"3":{"bias":-9.996031777652169,"weights":{"0":7.661332892053254,"1":1.563587172830952,"2":4.2957064186811795,"3":1.4981295084736872,"4":-1.9362232805364243,"5":-3.8527170343711474,"6":-10.557551043516103,"7":-6.125831134205862,"8":-2.790759200667976,"9":3.3098140433873455,"10":0.39472119366558195,"11":3.37715042260933}}}],"outputLookup":false,"inputLookup":false}';
        const NN300k10 = '{"layers":[{"0":{},"1":{},"2":{},"3":{},"4":{},"5":{},"6":{},"7":{},"8":{},"9":{},"10":{},"11":{},"12":{},"13":{},"14":{},"15":{},"16":{},"17":{},"18":{},"19":{},"20":{},"21":{},"22":{},"23":{}},{"0":{"bias":2.859601720911867,"weights":{"0":4.551533644532507,"1":-4.751371216120864,"2":22.89220388108024,"3":-23.321781497059067,"4":-11.717653779388895,"5":-12.333887396613948,"6":14.939406953769511,"7":-1.3578977666139327,"8":-4.25166533704931,"9":0.4124419000680533,"10":-1.1395039300646885,"11":-0.7357229076923413,"12":0.6629771226432974,"13":2.1460719869036873,"14":-2.972025962938888,"15":-4.124479642933121,"16":-21.36592548002889,"17":-1.1180589508487326,"18":-1.0842033210973574,"19":3.578889259718723,"20":10.577820140666589,"21":2.2026225113155853,"22":5.283744032251693,"23":-19.965924746044326}},"1":{"bias":-7.792589388140498,"weights":{"0":0.37804605445231887,"1":-4.251754652317512,"2":19.77571467689963,"3":-23.822034353686007,"4":19.141000563744395,"5":4.480430954303679,"6":-7.9964352451943945,"7":0.8159185235977807,"8":-8.407798439559107,"9":10.893524560392237,"10":-1.3175354068514562,"11":-2.7662213582377673,"12":10.983300232751672,"13":-4.275412076220654,"14":-0.2260614457282313,"15":-10.581928844596383,"16":29.079909650193397,"17":-27.972535706077622,"18":-13.049956440032862,"19":-10.05528369828623,"20":-6.469915465412593,"21":-14.663063493868677,"22":-41.35833872353277,"23":10.841685865539574}},"2":{"bias":-30.03066022812481,"weights":{"0":15.764032525543648,"1":-4.662824246642524,"2":43.51881843599881,"3":-34.180704059054925,"4":59.42359429328317,"5":-9.31299288180715,"6":20.971571646891746,"7":-4.218766606078241,"8":-25.232479204501196,"9":4.5130019947063404,"10":24.645880295011118,"11":-2.624490386514746,"12":19.823016167392073,"13":-3.484343717674994,"14":-0.1494404147222757,"15":1.5987426891955945,"16":46.979370565010136,"17":-6.237341235684291,"18":-6.873342518927745,"19":-21.22586821055658,"20":-5.0759507354272255,"21":0.7293425081824472,"22":18.241656318724527,"23":42.00271299122525}},"3":{"bias":-3.6559913685793535,"weights":{"0":-0.01715636437040405,"1":-0.21528450500078417,"2":21.113012665761012,"3":-14.309708159861065,"4":13.130552457655355,"5":4.611274454859461,"6":-4.547165564660803,"7":1.1015443021712084,"8":4.00175690295271,"9":-2.589949305101685,"10":-14.044955340459877,"11":5.761633438802702,"12":-2.0604309962148477,"13":2.539543610138284,"14":-2.8999003171180187,"15":0.5034277616875369,"16":23.686540472818816,"17":-23.44071080259544,"18":-17.40287646628749,"19":-10.127719751586055,"20":-12.350703600026891,"21":7.400587671969255,"22":11.052077035197087,"23":5.189911155801493}},"4":{"bias":15.942693471211282,"weights":{"0":-5.406472591601785,"1":4.092866459383854,"2":-15.192697424037506,"3":-0.7863126933101318,"4":-2.3534169619637524,"5":2.129655532528413,"6":-6.817372748522014,"7":4.781909237499872,"8":-2.2940255744271685,"9":2.560284245749515,"10":-17.67071205111363,"11":-1.2032282563644159,"12":2.7425981098184518,"13":-0.795734027016876,"14":-0.24604323692684982,"15":1.143406516297342,"16":-2.8583970172691497,"17":-0.6600314754922078,"18":1.5993547873430751,"19":1.9318102720730905,"20":-8.769283304207926,"21":-10.284689286887472,"22":-9.098247426587426,"23":-0.3171171331661587}},"5":{"bias":-7.632203389641369,"weights":{"0":-0.28317247105399773,"1":-35.546992207431195,"2":36.218752694988886,"3":-0.8021814815605385,"4":0.7059691066330238,"5":0.6201342079284408,"6":2.1077999607290643,"7":-2.065866247700602,"8":6.807738968323015,"9":0.2988629041486901,"10":-1.3421172158519266,"11":-2.0234205217738213,"12":6.021695528721089,"13":-1.8481476773795282,"14":-31.899273812160505,"15":-1.6504024516622977,"16":-0.8708615315791838,"17":-3.3202904895544125,"18":-7.888605997607075,"19":0.4987741027434337,"20":1.4722640820602253,"21":25.375298899802523,"22":50.974205283023444,"23":1.6147205822516344}},"6":{"bias":12.019955274389998,"weights":{"0":-20.540663107642125,"1":13.881344679658763,"2":-6.725345784713353,"3":3.4112559347320173,"4":11.90697311072871,"5":-14.920590082971803,"6":16.69763380448653,"7":-1.3635466121667088,"8":-44.71718975339774,"9":5.353831063640151,"10":7.261300374364674,"11":-1.3598731481495623,"12":11.91362337968332,"13":3.1633039377022523,"14":-4.20420563777592,"15":-0.587807684474049,"16":11.973489540269163,"17":-4.816002504667394,"18":-0.8748714499366474,"19":-9.595534958654405,"20":4.1262351535703194,"21":1.2826540581458947,"22":12.295872744395721,"23":6.3682326039834045}},"7":{"bias":0.7081499173598527,"weights":{"0":-16.070303150393514,"1":16.068420394284008,"2":-21.983990603745227,"3":0.004565306680997817,"4":3.972705423056623,"5":-1.097257541688594,"6":2.561944640796078,"7":-1.7098383607770749,"8":-3.4753418513430865,"9":-3.0025107278639043,"10":-6.84733661570147,"11":4.805593808176607,"12":-0.11805645789019559,"13":-1.4936581965655131,"14":5.374657918938545,"15":-4.108412616010305,"16":-61.24307727489257,"17":3.765811559886195,"18":11.806719341087023,"19":3.105266696426142,"20":-15.870317938486272,"21":-13.218312500847457,"22":-31.625955134767683,"23":-24.78030432297335}},"8":{"bias":1.4160095644119886,"weights":{"0":-12.59026644212346,"1":3.7891152956247725,"2":4.486732462356293,"3":-8.290507161998176,"4":-1.0614821942883583,"5":-1.364310606150455,"6":-12.697471148346708,"7":10.710326119826265,"8":-2.7377525456773912,"9":-2.0341133728298475,"10":6.660473437952434,"11":-4.063068940025606,"12":-1.297129344941189,"13":-1.422746902703382,"14":-7.48190533676844,"15":3.384918148218424,"16":-20.701046436230705,"17":-29.691816733004647,"18":-32.35238800521232,"19":-33.78076327237195,"20":-2.069363313131243,"21":7.508613029694234,"22":15.235627383230687,"23":-15.682663613599543}},"9":{"bias":1.483237951533863,"weights":{"0":-18.085739951508383,"1":17.04858990038456,"2":-36.87976612756434,"3":22.048054690195862,"4":-24.673769279420885,"5":-4.614097101797611,"6":2.6765340643419444,"7":0.5787297937073768,"8":0.30985633987140077,"9":-0.014901481015013601,"10":0.48179451005304164,"11":-0.4443702762683757,"12":-96.00179768872316,"13":5.308469666815853,"14":-4.165213348481972,"15":0.22074557739814496,"16":-8.466964597270636,"17":-4.442383081887052,"18":-2.0855293725246873,"19":-0.6802444096622537,"20":122.79581047475874,"21":-2.2685377893380667,"22":-7.532625551168981,"23":-12.566349216412679}},"10":{"bias":-18.147039772991075,"weights":{"0":11.148681332288696,"1":-6.585818239996348,"2":6.960073224797508,"3":-1.7412306892564058,"4":-12.869770569032369,"5":3.712648577278794,"6":10.54183419778098,"7":-9.780454329032661,"8":6.872182708292964,"9":1.5262445595187144,"10":-0.7029476976518447,"11":8.456517502438269,"12":-27.663034651710472,"13":1.7586689743020287,"14":20.92514896252264,"15":-3.175057237983516,"16":-27.199307229209747,"17":-2.402647828887522,"18":28.2590192491953,"19":41.759605390050346,"20":22.133179832221394,"21":0.4090320251014552,"22":5.126567394653984,"23":-3.906672743750222}},"11":{"bias":-10.54371190208461,"weights":{"0":5.1285990828411006,"1":-7.533614306099572,"2":12.86576369802837,"3":4.734608742675807,"4":-17.172046511633237,"5":12.006455444788415,"6":-12.94859952024766,"7":0.8586267518378,"8":11.481449322854441,"9":-1.195057104352695,"10":15.17937748431289,"11":1.9268521867982604,"12":-7.9255983138440325,"13":2.195991305399512,"14":-3.2696112172934972,"15":0.33348733734711367,"16":-21.18606444807385,"17":-20.151403498698674,"18":-23.24910745238394,"19":-5.654605044337377,"20":11.84673367364837,"21":19.83436868160417,"22":21.51785842388792,"23":3.8564860878085505}}},{"0":{"bias":-4.052081868372035,"weights":{"0":-3.508647721216008,"1":2.532962141248027,"2":1.8382475535115148,"3":2.118115480350906,"4":-2.994021494785248,"5":-5.996073438762416,"6":6.278906282996438,"7":-5.498776610629306,"8":-2.769535361160469,"9":-2.2171078219189235,"10":-2.725683630933355,"11":-3.1808880127259487}},"1":{"bias":-2.343618346538144,"weights":{"0":2.350542522171974,"1":-1.941488040447516,"2":-2.5426844319799935,"3":-3.323392978810492,"4":7.426875922793422,"5":-0.7358285828725282,"6":-3.2489913681630487,"7":5.884954249876669,"8":-2.1035954020161785,"9":-8.78585686500313,"10":-0.5135175946613861,"11":-2.720937604918123}},"2":{"bias":-2.4406215630265855,"weights":{"0":1.034534442951356,"1":-16.500393753934926,"2":-3.718828045580602,"3":4.0702557212111214,"4":-6.122388696258711,"5":-6.747868861925738,"6":2.0000908564161533,"7":-3.3731956861661723,"8":-2.622292684559956,"9":44.679497254717255,"10":3.523638766480639,"11":3.1827991925323635}},"3":{"bias":-2.9038581449449445,"weights":{"0":3.007431037799884,"1":-1.717425509048378,"2":3.4380661166189848,"3":0.7160424024434208,"4":-0.0871768434893494,"5":4.001858900826875,"6":-4.519561831908093,"7":-12.155443449216076,"8":3.4291580939369504,"9":-57.624869858080395,"10":-4.07886967997139,"11":2.111935304285209}}}],"outputLookup":false,"inputLookup":false}';
        this._loadNet(NN500k20); // Загрузка сети из json
        this._drawField();
        this._snake = new Snake(this._ctx, this._sizeCell, { x: Math.floor(this._sizeX / 2), y: Math.floor(this._sizeY / 2) });
        this._snake.draw();
        this._createFruit();
        this._drawFruit();
        this._startGame();
    }
    _startGame() {
        this._pauseBtn.disabled = false;
        clearInterval(this._processInterval);
        this._processInterval = setInterval(() => {
            this.step(this._isNet ? this.NetAction() : this.DFS());
            this._drawField();
            this._drawFruit();
            this._snake.draw();
        }, this._speed);
    }
    _pause() {
        this._isStarted = false;
        this._pauseBtn.disabled = true;
        clearInterval(this._processInterval);
    }
    _restart() {
        this._isStarted = false;
        clearInterval(this._processInterval);
        this._pauseBtn.disabled = true;
        this._drawField();
        this._snake = new Snake(this._ctx, this._sizeCell, { x: Math.floor(this._sizeX / 2), y: Math.floor(this._sizeY / 2) });
        this._snake.draw();
        this._createFruit();
        this._drawFruit();
        this._startGame();
    }
    _drawField() {
        for (let y = 0; y < this._sizeY; y++) {
            for (let x = 0; x < this._sizeX; x++) {
                this._ctx.fillStyle = ((x + (y % 2)) % 2 === 0) ? '#AAAAAA' : '#777777';
                this._ctx.fillRect(x * this._sizeCell, y * this._sizeCell, this._sizeCell, this._sizeCell);
            }
        }
    }
    _createFruit() {
        const snake = [this._snake.head, ...this._snake.body];
        let inSnake = true;
        let x;
        let y;
        while (inSnake) {
            x = Math.floor(Math.random() * (this._sizeX));
            y = Math.floor(Math.random() * (this._sizeY));
            inSnake = snake.some((item) => item.x === x && item.y === y);
        }
        this._fruit = { x, y };
    }
    _drawFruit() {
        this._ctx.fillStyle = '#AA0000';
        this._ctx.fillRect(this._fruit.x * this._sizeCell, this._fruit.y * this._sizeCell, this._sizeCell, this._sizeCell);
    }
    _getState() {
        const head = this._snake.head;
        let wallState = []; // Значения от 0 до 1
        let bodyState = new Array(8).fill(0); // Значения от 0 до 1 | 0 при отсутствии в поле видимости
        let foodState = new Array(8).fill(0); // Значения от 0 до 1 | 0 при отсутствии в поле видимости
        // Стенки
        wallState.push(head.y); // Вверх
        wallState.push(Math.min(this._sizeX - head.x, head.y)); // Вверх-вправо
        wallState.push(this._sizeX - head.x); // Вправо
        wallState.push(Math.min(this._sizeX - head.x, this._sizeY - head.y)); // Вниз-вправо 
        wallState.push(this._sizeY - head.y); // Вниз
        wallState.push(Math.min(head.x, this._sizeY - head.y)); // Вниз-влево
        wallState.push(head.x); // Влево
        wallState.push(Math.min(head.x, head.y)); // Вверх-влево
        wallState = wallState.map((n) => { return n != 0 ? Number((1 / n).toFixed(2)) : 0; }); // Нормализация от 0 до 1
        // Тело
        let mpX; // Множитель для X
        let mpY; // Множитель для Y
        for (let i = 0; i < 8; i++) {
            mpX = (i > 4) ? -1 : ((i < 4 && i > 0) ? 1 : 0);
            mpY = (i > 2 && i < 6) ? 1 : ((i > 6 || i < 2) ? -1 : 0);
            let distance = 1;
            while (!(head.x + (distance * mpX) < 0 || head.x + (distance * mpX) >= this._sizeX || head.y + (distance * mpY) < 0 || head.y + (distance * mpY) >= this._sizeY)) {
                if (this._snake.body.filter((item) => item.x === head.x + (distance * mpX) && item.y === head.y + (distance * mpY)).length > 0) {
                    bodyState[i] = distance;
                    break;
                }
                distance++;
            }
        }
        bodyState = bodyState.map((n) => { return n != 0 ? Number((1 / n).toFixed(2)) : 0; });
        // Еда
        if (head.x === this._fruit.x) { // Верх/Низ
            head.y > this._fruit.y ? foodState[0] = head.y - this._fruit.y : foodState[4] = this._fruit.y - head.y;
        }
        else if (head.y === this._fruit.y) { // Лево/Право
            head.x > this._fruit.x ? foodState[6] = head.x - this._fruit.x : foodState[2] = this._fruit.x - head.x;
        }
        else if (head.x - this._fruit.x === head.y - this._fruit.y) { // Диагональ с лева направо, сверху вниз
            head.x > this._fruit.x ? foodState[7] = Math.abs(head.x - this._fruit.x) : foodState[3] = Math.abs(head.x - this._fruit.x);
        }
        else if (Math.abs(head.x - this._fruit.x) === Math.abs(head.y - this._fruit.y)) { // Диагональ с лева направо, снизу вверх
            head.x > this._fruit.x ? foodState[5] = Math.abs(head.x - this._fruit.x) : foodState[1] = Math.abs(head.x - this._fruit.x);
        }
        foodState = foodState.map((n) => { return n != 0 ? Number((1 / n).toFixed(2)) : 0; }); // Нормализация от 0 до 1
        return [...wallState, ...bodyState, ...foodState];
    }
    step(action) {
        console.log(this._steps);
        this._setTextDivBlock();
        if (this._steps < this._stepsNeeded && !this._isNet) {
            this._setTrainData(this._getState(), this.DFS());
        }
        this._steps++;
        this._life--;
        if (this._steps === this._stepsNeeded && !this._isNet) {
            this.NetTrain();
            this._trainData = [];
        }
        const max = Math.max.apply(null, action);
        let indexMax = action.indexOf(max);
        this._snake.direction = Math.abs(this._snake.direction - indexMax) === 2 ? this._snake.direction : indexMax;
        const head = Object.assign({}, this._snake.head);
        switch (this._snake.direction) {
            case Direction.Up:
                head.y--;
                break;
            case Direction.Down:
                head.y++;
                break;
            case Direction.Right:
                head.x++;
                break;
            case Direction.Left:
                head.x--;
                break;
        }
        if (!this._checkIsAlive(head)) {
            this._endGame();
            return;
        }
        if (this._life <= 0) {
            this._endGame();
            return;
        }
        let growing = false;
        if (this._checkFruit(head)) {
            this._createFruit();
            this._drawFruit();
            this._life = 500;
            growing = true;
        }
        this._snake.move(growing);
    }
    _setTextDivBlock() {
        if (this._isNet) {
            if (this._snake.body.length + 1 > this._maxLength) {
                this._maxLength = this._snake.body.length + 1;
                this._MaxLengthNN.textContent = this._maxLength.toString();
            }
            this._LengthNN.textContent = (this._snake.body.length + 1).toString();
            this._CountGameNN.textContent = this._countGame.toString();
            this._LifeNN.textContent = this._life.toString();
        }
        else {
            if (this._snake.body.length + 1 > this._maxLength) {
                this._maxLength = this._snake.body.length + 1;
                this._MaxLengthA.textContent = this._maxLength.toString();
            }
            this._LengthA.textContent = (this._snake.body.length + 1).toString();
            this._CountGameA.textContent = this._countGame.toString();
            this._LifeA.textContent = this._life.toString();
        }
    }
    // Получение действия от сети
    NetAction() {
        const action = this._net.run(this._getState());
        console.log(action);
        return action;
    }
    // Сбор данных
    _setTrainData(inp, out) {
        this._trainData.push({ input: inp, output: out });
    }
    // Обучение сети
    NetTrain() {
        this._pause();
        console.log('Обучение...');
        this._net.train(this._trainData, {
            log: true,
            logPeriod: 100,
            errorThresh: 0.01,
            iterations: 1000,
            timeout: Infinity,
            learningRate: 0.2,
        });
        console.log('Обучилось!');
        this._saveNet();
        this._isNet = true;
        this._maxLength = 0;
        this._countGame = 1;
        this._speed = 50;
        this._restart();
    }
    // Сохранение сети
    _saveNet() {
        const json = JSON.stringify(this._net.toJSON());
        this._jsonDiv.innerHTML = json;
    }
    // Загрузка сети
    _loadNet(jsonFile) {
        jsonFile = JSON.parse(jsonFile);
        this._net.fromJSON(jsonFile);
        this._isNet = true;
    }
    DFS() {
        const fruit = this._fruit;
        const head = this._snake.head;
        let field = new Array(this._sizeY);
        for (let i = 0; i < field.length; i++) {
            field[i] = new Array(this._sizeX).fill(100);
        }
        field[fruit.y][fruit.x] = 80;
        field[head.y][head.x] = 0;
        for (let item of this._snake.body) {
            field[item.y][item.x] = 150;
        }
        let mainArray = [head];
        let assistArray = [];
        let findFood = false;
        const offset = [-1, 1, 1, -1];
        let num = 1;
        let offY;
        let offX;
        while (!findFood) {
            assistArray = mainArray;
            mainArray = [];
            for (let item of assistArray) {
                for (let i = 0; i < 4; i++) {
                    offY = (i % 2 === 0) ? offset[i] : 0;
                    offX = (i % 2 === 0) ? 0 : offset[i];
                    if ((item.y + offY || item.x + offX) < 0 || (item.y + offY >= this._sizeY || item.x + offX >= this._sizeX)) {
                        continue;
                    }
                    if (field[item.y + offY][item.x + offX] === 150) {
                        continue;
                    }
                    if (field[item.y + offY][item.x + offX] === 100 && field[item.y + offY][item.x + offX] != 0 || field[item.y + offY][item.x + offX] === 80) {
                        if (item.y + offY === fruit.y && item.x + offX === fruit.x) {
                            findFood = true;
                        }
                        field[item.y + offY][item.x + offX] = num;
                        let x = item.x + offX;
                        let y = item.y + offY;
                        mainArray.push({ x, y });
                    }
                }
            }
            num++;
            if (num > (this._sizeY * 3))
                break;
        }
        let currentPoint = fruit;
        const way = [fruit];
        let findWay = false;
        while (!(currentPoint.x === head.x && currentPoint.y === head.y)) {
            let countWay = 0;
            for (let i = 0; i < 4; i++) {
                offY = (i % 2 === 0) ? offset[i] : 0;
                offX = (i % 2 === 0) ? 0 : offset[i];
                const item = { x: (currentPoint.x + offX), y: (currentPoint.y + offY) };
                if (item.x < 0 || item.y < 0 || item.x >= this._sizeX || item.y >= this._sizeY) {
                    continue;
                }
                if (field[item.y][item.x] < field[currentPoint.y][currentPoint.x]) {
                    way.push(item);
                    currentPoint = item;
                    findWay = true;
                    countWay++;
                    break;
                }
            }
            if (countWay === 0) {
                findWay = false;
                break;
            }
        }
        way.pop();
        let nearestPoint;
        let dirX;
        let dirY;
        if (findWay) {
            nearestPoint = way.pop();
            dirX = nearestPoint.x - head.x;
            dirY = nearestPoint.y - head.y;
        }
        else {
            for (let i = 0; i < 4; i++) {
                offY = (i % 2 === 0) ? offset[i] : 0;
                offX = (i % 2 === 0) ? 0 : offset[i];
                const item = { x: (head.x + offX), y: (head.y + offY) };
                if (item.x < 0 || item.y < 0 || item.x >= this._sizeX || item.y >= this._sizeY) {
                    continue;
                }
                if (field[item.y][item.x] > field[head.y][head.x] && field[item.y][item.x] < 100) {
                    dirX = item.x - head.x;
                    dirY = item.y - head.y;
                    break;
                }
            }
        }
        if (dirX === 0 && dirY === -1)
            return [1, 0, 0, 0];
        else if (dirX === 1 && dirY === 0)
            return [0, 1, 0, 0];
        else if (dirX === 0 && dirY === 1)
            return [0, 0, 1, 0];
        else
            return [0, 0, 0, 1];
    }
    _checkFruit(head) {
        if (head.x === this._fruit.x && head.y === this._fruit.y) {
            return true;
        }
        return false;
    }
    _checkIsAlive(head) {
        // Проверка на столкновение со стеной
        if ((head.x < 0) || (head.x >= this._sizeX) || (head.y < 0) || (head.y >= this._sizeY)) {
            return false;
        }
        // Проверка на столкновение с туловищем
        for (const item of this._snake.body) {
            if (item.x === head.x && item.y === head.y) {
                return false;
            }
        }
        return true;
    }
    _endGame() {
        this._life = 500;
        this._countGame++;
        this._snake = new Snake(this._ctx, this._sizeCell, { x: Math.floor(this._sizeX / 2), y: Math.floor(this._sizeY / 2) });
        this._drawField();
        this._snake.draw();
        this._createFruit();
        this._drawFruit();
        this._pauseBtn.disabled = true;
        console.log('Поражение!');
    }
}
class Snake {
    constructor(context, size, startPoint) {
        this.body = [];
        this.direction = Direction.Up;
        this._ctx = context;
        this._sizeCell = size;
        this.head = startPoint;
        this.body.push({ x: this.head.x, y: (this.head.y + 1) }, { x: this.head.x, y: (this.head.y + 2) });
    }
    draw() {
        this._ctx.fillStyle = '#008800';
        this._ctx.fillRect(this.head.x * this._sizeCell, this.head.y * this._sizeCell, this._sizeCell, this._sizeCell);
        for (let i = 0; i < this.body.length; i++) {
            this._ctx.fillStyle = '#008800';
            this._ctx.fillRect(this.body[i].x * this._sizeCell, this.body[i].y * this._sizeCell, this._sizeCell, this._sizeCell);
            this._ctx.fillStyle = '#00BB00';
            this._ctx.fillRect(this.body[i].x * this._sizeCell + 2, this.body[i].y * this._sizeCell + 2, this._sizeCell - 4, this._sizeCell - 4);
        }
    }
    move(growing) {
        const oldHead = Object.assign({}, this.head);
        this.body.unshift(oldHead);
        if (!growing)
            this.body.pop();
        switch (this.direction) {
            case Direction.Up:
                this.head.y--;
                break;
            case Direction.Down:
                this.head.y++;
                break;
            case Direction.Right:
                this.head.x++;
                break;
            case Direction.Left:
                this.head.x--;
                break;
        }
    }
    randomAction() {
        const random = Math.random();
        if (random < 0.25)
            return [1, 0, 0, 0];
        if (random < 0.5)
            return [0, 1, 0, 0];
        if (random < 0.75)
            return [0, 0, 1, 0];
        return [0, 0, 0, 1];
    }
}
var Direction;
(function (Direction) {
    Direction[Direction["Up"] = 0] = "Up";
    Direction[Direction["Right"] = 1] = "Right";
    Direction[Direction["Down"] = 2] = "Down";
    Direction[Direction["Left"] = 3] = "Left";
})(Direction || (Direction = {}));
const game = new Game;
